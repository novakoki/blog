<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Jade如何用同一模板渲染出不同文章的页面 · Consolas</title><meta name="description" content="Jade如何用同一模板渲染出不同文章的页面 - Ziqi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/blog/" class="logo-link"><img src="/blog/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/blog/tags/" target="_self" class="nav-list-link">TAGS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Jade如何用同一模板渲染出不同文章的页面</h1><div class="post-time">Apr 2, 2016</div><div class="post-content"><h2 id="What"><a href="#What" class="headerlink" title="What:"></a>What:</h2><p>在写我的<a href="https://github.com/novakoki/blog-generator" target="_blank" rel="external">blog-generator</a>的时候，遇到了传说中面试经常考的对象复制的问题。<br>在用Jade模板的时候，要用同一个模板渲染出不同的文章，就需要有不同的locals。<br>一开始的想法是，用Jade里面的include markdown，这样只要文件名做变量就可以了，然而事实上Jade并不支持动态include。<br>于是只能改用先用marked解析markdown文件为字符串然后填充进去，假设有如下内容</p>
<p>post.jade<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article !&#123;article&#125; </span><br><span class="line">//- 这里是解析markdown后得到的字符串，会带有很多转义符号，所以用 !&#123;&#125;的变量表达</span><br></pre></td></tr></table></figure></p>
<p>locals.json<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"articles"</span>: &#123;</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"path"</span>,</span><br><span class="line">    <span class="attr">"title1"</span>: <span class="string">"path1"</span></span><br><span class="line">  &#125;,  </span><br><span class="line">  <span class="attr">"article"</span>: <span class="string">"balabala..."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>那么在JavaScript中就可以<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'template'</span>, ()=&gt;&#123;</span><br><span class="line">  <span class="keyword">var</span> locals = <span class="built_in">require</span>(<span class="string">'./locals.json'</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> title <span class="keyword">in</span> locals.articles) &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    这里做markdown解析并改变locals中article的值</span><br><span class="line">    */</span></span><br><span class="line">    </span><br><span class="line">    gulp.src(<span class="string">'./post.jade'</span>)</span><br><span class="line">      .pipe(jade(&#123;</span><br><span class="line">        locals: locals</span><br><span class="line">      &#125;)</span><br><span class="line">      .pipe(rename(<span class="string">`<span class="subst">$&#123;title&#125;</span>.html`</span>) <span class="comment">//gulp.dest只能指定输出的目录而不能指定文件名，需要rename = require('gulp-rename')</span></span><br><span class="line">      .pipe(gulp.dest(<span class="string">'./posts'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后一切都是由异步引起的问题了，为了符合gulp的风格，我用stream来读取markdown文件的内容<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stream = fs.createReadStream(locals.articles[title]);</span><br><span class="line"><span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">stream.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  data += chunk;</span><br><span class="line">&#125;);</span><br><span class="line">stream.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  locals.article = marked(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>因为显然这个过程是异步的，所以我用一个闭包来存每次迭代的title<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'template'</span>, ()=&gt;&#123;</span><br><span class="line">  <span class="keyword">var</span> locals = <span class="built_in">require</span>(<span class="string">'./locals.json'</span>); <span class="comment">//这里我一度以为locals也会是在闭包环境里的</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> title <span class="keyword">in</span> locals.articles) &#123;</span><br><span class="line">    ((title, locals) =&gt; &#123;</span><br><span class="line">      <span class="keyword">var</span> stream = fs.createReadStream(locals.articles[title]);</span><br><span class="line">      <span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">      stream.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">        data += chunk;</span><br><span class="line">      &#125;);</span><br><span class="line">      stream.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">        locals.article = marked(data); <span class="comment">//这里是会影响外部的locals的</span></span><br><span class="line">        gulp.src(<span class="string">'./post.jade'</span>)</span><br><span class="line">        .pipe(jade(&#123;</span><br><span class="line">          locals: locals</span><br><span class="line">        &#125;)</span><br><span class="line">        .pipe(rename(<span class="string">`<span class="subst">$&#123;title&#125;</span>.html`</span>)</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./posts'</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)(title, locals);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>事实上这样最终只会产生相同的页面，即最后迭代的那一次。<br>意识到了其中的问题所在之后，我继续做了些修改<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'template'</span>, ()=&gt;&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> title <span class="keyword">in</span> locals.articles) &#123;</span><br><span class="line">    ((title) =&gt; &#123;</span><br><span class="line">      <span class="keyword">var</span> stream = fs.createReadStream(locals.articles[title]);</span><br><span class="line">      <span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">      <span class="keyword">var</span> locals = <span class="built_in">require</span>(<span class="string">'./locals.json'</span>); <span class="comment">//喂，这样总可以每个闭包环境都有一份locals了吧</span></span><br><span class="line">      stream.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">        data += chunk;</span><br><span class="line">      &#125;);</span><br><span class="line">      stream.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">        locals.article = marked(data); </span><br><span class="line">        gulp.src(<span class="string">'./post.jade'</span>)</span><br><span class="line">        .pipe(jade(&#123;</span><br><span class="line">          locals: locals</span><br><span class="line">        &#125;)</span><br><span class="line">        .pipe(rename(<span class="string">`<span class="subst">$&#123;title&#125;</span>.html`</span>)</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./posts'</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)(title);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果是被第二次打脸了，于是我只好寻求复制多份原始的locals，再分别做设置。<br>这里我没有用比较常规的写一个递归函数或者用原型来做复制，而是选择直接操作JSON字符串。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stream.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  gulp.src(<span class="string">'./post.jade'</span>)</span><br><span class="line">    .pipe(jade(&#123;</span><br><span class="line">      locals: <span class="built_in">JSON</span>.parse(<span class="string">`<span class="subst">$&#123;JSON.stringify(locals).slice(0,-1)&#125;</span>,<span class="subst">$&#123;marked(data)&#125;</span>&#125;`</span>, <span class="literal">null</span>, <span class="number">4</span>) <span class="comment">//这里要注意缩进是因为locals.json应该有一部分是用户可自行修改的</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .pipe(rename(<span class="string">`<span class="subst">$&#123;title&#125;</span>.html`</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'./posts'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这样就用同一个模板给每篇文章都生成了一个页面，相应的，主页中需要展示一个文章摘要列表也可以做类似的实现。</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why:"></a>Why:</h2><p>回到上面的过程中，为什么我说一切问题都是由异步引起的？更确切些，可以说是由异步和引用类型引起的。</p>
<p>首先，无论是node自身的stream还是gulp的stream，在读取或是写入时都是异步执行的，用于迭代的变量最终被用到时循环早已结束，这样的情形在DOM批量绑定事件的时候也早已见怪不怪了。</p>
<p>一个简单的闭包可以解决问题，这么做了之后第一次修改我意识到了问题在于传参的类型，字符串、数字都在闭包中保存了一份拷贝，而引用类型或者说对象并没有，或者说在闭包中只是存了一份该指向对象指针的拷贝而已。</p>
<p>改完之后为什么还是不对呢？确实每个闭包都有了一个locals才对啊。问题在于gulp的stream也是异步的，即gulp用到locals的时候，外面的函数调用已经结束了，locals作为局部变量已经被销毁了。</p>
<h2 id="How"><a href="#How" class="headerlink" title="How:"></a>How:</h2><p>《JavaScript高级程序设计》 P69-71</p>
<p><a href="http://jerryzou.com/posts/dive-into-deep-clone-in-javascript/" target="_blank" rel="external">深入剖析 JavaScript 的深复制</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/blog/Margin-Collapsing/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'shaoziqi';
var disqus_identifier = 'JS-Object-Clone/';
var disqus_title = 'Jade如何用同一模板渲染出不同文章的页面';
var disqus_url = 'http://shaoziqi.tk/blog/JS-Object-Clone/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//shaoziqi.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2016 <a href="http://shaoziqi.tk/blog">Ziqi</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>